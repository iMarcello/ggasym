---
title: "Plotting statistical significance and difference in values"
author: "Joshua H. Cook"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ggasym}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(ggasym)
```

For this example, I will be using the included `enrichment_data` tibble. It is printed below and further information can be found in the documentation (`?enrichment_data`).

```{r}
enrichment_data
```

The data is the result of finding the pathways associated with the various Hallmarks of Cancer ([COSMIC - Hallmarks of Cancer](https://cosmic-blog.sanger.ac.uk/hallmarks-cancer/)) that are enriched for mutations among 7 cancer types (labeled as `tissue A-G`). Each row in the tibble is a test of the enrichment scores of the `hallmark` between the cancer types in `comparison`. The `estimate` is the different between average values of the two cancers, and the `adj.p.value` is the multiple hypothesis testing-corrected (Benjamini and Hochberg) p-value (sometimes called the q-value). The statistical test was an ANOVA for each Hallmark and then Tukey tests between each cancer type. The data was then cast into a tibble using [`broom::tidy()`](https://broom.tidyverse.org)

I would like to plot a matrix of $tissue \times tissue$, coloring the top-left by `estimate` and bottom-right by $-\log_{10} \text{q-value}$. 

First, I need to break up the `comparison` into the two tissues being tested.

```{r}
enrich_data <- enrichment_data %>%
    mutate(tissue_1 = str_split_fixed(comparison, "-", 2)[, 1],
           tissue_2 = str_split_fixed(comparison, "-", 2)[, 2])
```

I also need to calculate the $-\log_{10} \text{q-value}$, first setting any $0$ values to $10^{-6}$.

```{r}
enrich_data <- enrich_data %>%
    mutate(neg_log10 = - log10(adj.p.value)) 
```

Here are the results of the above mutations

```{r}
enrich_data %>% select(hallmark, tissue_1, tissue_2, estimate, neg_log10)
```

We can now plot by passing the data table to `geom_asymmat`, returning a ggplot object.

```{r}
geom_asymmat(enrich_data, tissue_1, tissue_2, estimate, neg_log10)
```

```{r}
 ggplot(enrich_data) +
    geom_tile(aes(x = tissue_1, y = tissue_2, fill = estimate)) +
    scale_fill_gradient(low = "dodgerblue", high = "tomato") +
    ggnewscale::new_scale_fill() +
    geom_tile(aes(x = tissue_2, y = tissue_1, fill = neg_log10)) +
    scale_fill_gradient(low = "white", high = "green")
```


These 4 arguments are the only ones required, but the plot can be improved by passing values for the `color_tl/br` to color the lines between the tiles and `lab_tl/br` to label the scales for the top and bottom coloring schemes.

```{r}
g <- geom_asymmat(enrich_data, tissue_1, tissue_2, estimate, neg_log10,
                  color_tl = "black", color_br = "black",
                  lab_tl = "estimate", lab_br = "-log10( q-value )")
plot(g)
class(g)
```

Since the returned value is a ggplot object, it can be modified just like any other time you have used `ggplot() + geom_*()`. For example, I will remove the gap between the axes and the data.

```{r}
g <- g + scale_x_discrete(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0))
plot(g)
```

The values along the diagonal are all `NA`, therefore, the background color is just showing through. I will adjust the `theme` to make this look a bit better. I hope to implement a third `fill` aesthetic for these data points in the future.

```{r}
g <-g + theme(panel.background = element_rect(fill = "grey50"),
              panel.border = element_rect(fill = NA, color = "black"),
              axis.title = element_blank(),
              axis.text.x = element_text(angle = 45, hjust = 1),
              panel.grid = element_blank())
plot(g)
```

